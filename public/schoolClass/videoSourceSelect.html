<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>本地课件播放方案</title>

    <link rel="icon" href="img/logo_title.png" type="image/x-icon">
    <link type="text/css" rel="stylesheet" href="css/record_list.css?v=35" />

    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/hashmap.js"></script>
    <script type="text/javascript" src="js/layer/layer.js"></script>
    <script type="application/javascript" src="../openvidu-browser-2.6.0.js"></script>
    <script type="text/javascript" src="../ExRTCSDK-2.4.0.js"></script>
    <script type="text/javascript" src="js/service.js"></script>
    <script type="application/javascript" src="https://jsmpeg.com/jsmpeg.min.js"></script>
    <script type="text/javascript" src="js/platform.js"></script>
    <script type="text/javascript" src="js/socket.io.js"></script>
    <script type="text/javascript" src="js/MultiStreamsMixer.js"></script>
    <script type="text/javascript" src="js/ServerRecord.js"></script>
    <style type="text/css">
        .layui-layer {
            box-shadow: 0px 6px 50px rgba(0, 0, 0, 0.4) !important;
        }
        .layer-anim{
            animation:none !important;
        }
    </style>
</head>

<body>
    <div class="videoSource-wrap">
        <div class="menu">
            <span onclick="addIpCamera();" class="menu-btn"><i class="videoSource-menu2"></i>网络摄像头</span>
            <span onclick="addLocalCamera()" class="menu-btn"><i class="videoSource-menu1"></i>本机摄像头</span>
            <span onclick="addScreen()" style="display: none;" class="menu-btn" id="screen_menu"><i class="videoSource-menu4"></i>添加桌面</span>
        </div>

        <div id="video_sources" class="videoSource_content">
            <div class="empty_center">
                <i class="videoSource-empty"></i>
                <div class="videoSource-empty-text">视频预览区</div>
            </div>

        </div>

    </div>

</body>

<script type="text/javascript">
    //存输入的rts地址
    var rtspUrlArr = [];
    rtspUrlArr = JSON.parse(localStorage.getItem("rtspUrl")) == null ? rtspUrlArr : JSON.parse(localStorage.getItem("rtspUrl"))
    var vid = Service.getQueryString("vid");
    var teacherId = Service.getQueryString("teacherId");
    var defaultPort = 9999;
    var jsmpegPlayer;
    var ipc = window.top.require('electron').ipcRenderer;
    var rtspPortMap = new HashMap();
    var from = Service.getQueryString("from");
     
    function addLocalCamera() {
        var childrenSize = $("#video_sources").children().length;
        if(from == "slaver" &&childrenSize > 1){
            layer.msg("请先移除已添加视频源");
            return;
        }
        navigator.mediaDevices.enumerateDevices()
            .then(function (devices) {
                var audios = new Array();
                var videos = new Array();
                var audioHtml = "<span class='left left2'>音频\n</span><div class='right-item'>";
                var videoHtml = "<span class='left left2'>视频\n</span><div class='right-item'>";

                devices.forEach(function (device) {
                    if (device.deviceId == 'default') {
                        return;
                    }
                    if (device.kind == 'audioinput') {
                        audios.push(device);
                        audioHtml = audioHtml + "<label class='right'><input class='a-radio' name='audioinput' type='radio' value='" + device.deviceId + "' />" + "<span class='b-radio'></span><span class='b-ridioText'>" + device.label + "</span></label>";
                    } else if (device.kind == 'videoinput') {
                        videos.push(device);
                        videoHtml = videoHtml + "<label class='right'><input class='a-radio' name='videoinput' type='radio' value='" + device.deviceId + "' />" + "<span class='b-radio'></span><span class='b-ridioText'>" + device.label + "</span></label>";
                    }
                    console.log(device.kind + ": " + device.label + " id = " + device.deviceId);
                });

                audioHtml = audioHtml + "</div>";
                videoHtml = videoHtml + "</div>";

                layer.open({
                    type: 1,
                    closeBtn: 0,
                    title: "请选择本地摄像头",
                    skin: "videoSource",
                    area: ['100%', '480px'], //宽高
                    offset: 'b',
                    content: "<div class='list-content'><div class='list-item'>" + videoHtml + "</div><div class='list-item'>" + audioHtml + "</div><div class='list-item'><span class='left left2'>昵称</span><div class='inputWrap inputWrap-3'><input id='nick'  class='right nickname' /></div></div><div class='list-item list-item-video'><video id='preview_video' width='254px' height='150px' autoplay muted></video></div></div><div class='btn-cont'><span onclick='layer.closeAll();' class='btn-blue Ghost-btn' >取消</span><span onclick='preView();' class='btn-blue Solid-btn'>预览</span><span onclick='useInclass();' class='btn-blue Solid-btn'>使用</span></div>"
                });

            }).catch(function (err) {
                console.log(err.name + ": " + err.message);
            });
    }

    function addIpCamera() {
        var browser = platform.name;
        if(browser.indexOf("Electron") == -1){
            layer.msg("请在pc客户端中使用此功能~~");
            return;
        }
        var childrenSize = $("#video_sources").children().length;
        if(from == "slaver" &&childrenSize > 1){
            layer.msg("请先移除已添加视频源");
            return;
        }
        detectRtspCameraAudio(function(audios,audioHtml){
            var html = "";
            if(audios.length > 0){
                html = "<div class='list-content'><div class='list-item'><span class='left'>rtsp地址</span><div class='inputWrap'><input id='rtsp_url' class='right nickname' value='rtsp://184.72.239.149/vod/mp4:BigBuckBunny_115k.mov'/><div style='display:none' id='rtsUrl'></div></div></div><div class='list-item'>"+audioHtml+"</div><div class='list-item'><span class='justify left'>课堂昵称<span></span></span><div class='inputWrap'><input id='nick' class='right nickname'/></div></div><div class='list-item list-item-video'><canvas id='rtsp_preview_canvas' width='299px' height='161px'></canvas></div></div><div class='btn-cont'><span onclick='cancelUseRtsp();' class='btn-blue Ghost-btn'>取消</span><span onclick='rtspPreview();' class='btn-blue Solid-btn'>预览</span><span onclick='useRtspInclass(this)' id='useBtn' class='btn-blue Solid-btn'" +
                    ">使用</span></div>";
            }else{
                html = "<div class='list-content'><div class='list-item'><span class='left'>rtsp地址</span><div class='inputWrap'><input id='rtsp_url' class='right nickname' value='rtsp://184.72.239.149/vod/mp4:BigBuckBunny_115k.mov'/><div style='display:none' id='rtsUrl'></div></div></div><div class='list-item'><span class='justify left'>课堂昵称<span></span></span><div class='inputWrap'><input id='nick' class='right nickname'/></div></div><div class='list-item list-item-video'><canvas id='rtsp_preview_canvas' width='299px' height='161px'></canvas></div></div><div class='btn-cont'><span onclick='cancelUseRtsp();' class='btn-blue Ghost-btn'>取消</span><span onclick='rtspPreview();' class='btn-blue Solid-btn'>预览</span><span onclick='useRtspInclass(this)' id='useBtn' class='btn-blue Solid-btn'" +
                    ">使用</span></div>";
            }

            layer.open({
                type: 1,
                title: "请选择网络摄像头",
                closeBtn: 0,
                skin: "videoSource",
                area: ['100%', '480px'], //宽高
                offset: 'b',
                content: html
            });
            //设置rts的值
            getRtsUrl = function (url) {
                $("#rtsp_url").val(url)
            }
            rtspUrlArr = makeArr(rtspUrlArr, "url")
            //显示输入过的值
            rtspUrlArr.forEach(function (v, i) {
                $("#rtsUrl").append(`<div onClick='getRtsUrl("${v.url}")'>${v.url}</div>`)
            })
            $("#rtsp_url").focus(function () {
                $("#rtsUrl").css("display", "block");
            })
            $("#rtsp_url").blur(function () {
                rtspUrlArr = JSON.parse(localStorage.getItem("rtspUrl")) == null ? rtspUrlArr : JSON.parse(localStorage.getItem("rtspUrlArr"))
                setTimeout(function () {
                    $("#rtsUrl").css("display", "none");
                }, 300)
            });
        });
    }


    function detectRtspCameraAudio(onDetectFinish){
        var audios = new Array();
        var audioHtml = "<span class='left'>音&nbsp&nbsp&nbsp&nbsp&nbsp频\n</span><div class='right-item' style='margin-left: 1px'>";
        navigator.mediaDevices.enumerateDevices()
            .then(function (devices) {

                devices.forEach(function (device) {
                    if (device.deviceId == 'default') {
                        return;
                    }
                    if (device.kind == 'audioinput') {
                        audios.push(device);
                        audioHtml = audioHtml + "<label class='right'><input class='a-radio' name='audioinput' type='radio' value='" + device.deviceId + "' />" + "<span class='b-radio'></span><span class='b-ridioText'>" + device.label + "</span></label>";
                    }
                    console.log(device.kind + ": " + device.label + " id = " + device.deviceId);
                });
                audioHtml = audioHtml + "</div>";
                onDetectFinish(audios,audioHtml);
            }).catch(function (err) {
                console.log(err.name + ": " + err.message);
                onDetectFinish(audios,audioHtml);
            });
    }


    function cancelUseRtsp() {
        var rtspUrl = $("#rtsp_url").val();
        if(rtspUrl == null || rtspUrl == undefined || rtspUrl == ""){
            return;
        }

        if (jsmpegPlayer) {
            var message = {};
            message.command = "stopRtspStream";
            message.wsPort = defaultPort;
            ipc.send('onRendererMessage', message);

            try{
                jsmpegPlayer.destroy();
            }catch (e) {
                console.log(e);
            }
            jsmpegPlayer = null;
        }

        layer.closeAll();
    }

    function rtspPreview() {
        var rtspUrl = $("#rtsp_url").val();
        rtspUrlArr = JSON.parse(localStorage.getItem("rtspUrl")) == null ? rtspUrlArr : JSON.parse(localStorage.getItem("rtspUrl"))
        if ($.trim($("#rtsp_url").val()) != "" || $("#rtsp_url").val() != undefined) {
            rtspUrlArr.push(
                {
                    url: $.trim($("#rtsp_url").val())
                }
            )
        }
        rtspUrlArr = makeArr(rtspUrlArr, "url")
        localStorage.setItem("rtspUrl", JSON.stringify(rtspUrlArr));
        var port = rtspPortMap.get(rtspUrl);
        if(port == null || port == undefined || port == ""){
            defaultPort = defaultPort + 1;
            port = defaultPort;
        }
        var message = {};
        message.command = "startRtspStream";
        message.streamUrl = rtspUrl;
        message.wsPort = port;
        ipc.send('onRendererMessage', message);

        var canvas = $("#rtsp_preview_canvas")[0];
        jsmpegPlayer = new JSMpeg.Player('ws://localhost:' + port, { loop: true, autoplay: true, canvas: canvas, audio: false });
    }

    /**
     * 数组去重
     * @param arr
     * @returns {*}
     */
    function makeArr(arr, properties) {
        for (var i = 0; i < arr.length - 1; i++) {
            for (var j = i + 1; j < arr.length; j++) {
                if (arr[i][properties] == arr[j][properties]) {
                    arr.splice(j, 1);
                    j--;
                }
            }
        }
        return arr
    }


    function useRtspInclass() {
        var nick = $("#nick").val();
        var rtspUrl = $("#rtsp_url").val();
        var audioDeviceId = $("[name='audioinput']").filter(":checked").val();
        if (rtspUrl == undefined || rtspUrl == "") {
            layer.msg("请输入网络摄像头流地址~~");
            return;
        }
        if(audioDeviceId == undefined || audioDeviceId == ""){
            layer.msg("请选择音频设备~~");
            return;
        }
        if (typeof (nick) == "undefined" || nick == "") {
            layer.msg("请输入此设备在课堂中的昵称~~");
            return;
        }

        rtspUrlArr = JSON.parse(localStorage.getItem("rtspUrl")) == null ? rtspUrlArr : JSON.parse(localStorage.getItem("rtspUrl"))
        
        if ($.trim($("#rtsp_url").val()) != "" || $("#rtsp_url").val() != undefined) {
            rtspUrlArr.push(
                {
                    url: $.trim($("#rtsp_url").val())
                }
            )
        }
        rtspUrlArr = makeArr(rtspUrlArr, "url")
        localStorage.setItem("rtspUrl", JSON.stringify(rtspUrlArr));
        layer.closeAll();

        addUsingIpCameraInfo(nick,rtspUrl,audioDeviceId);
        innerUseIpCamera(nick,rtspUrl,audioDeviceId);
    }

    function innerUseIpCamera(nick,rtspUrl,audioDeviceId){
        if (jsmpegPlayer) {
            var message = {};
            message.command = "stopRtspStream";
            message.wsPort = defaultPort;
            ipc.send('onRendererMessage', message);

            try{
                jsmpegPlayer.destroy();
            }catch (e) {
                console.log(e);
            }
            jsmpegPlayer = null;
        }
        var publish = Service.getQueryString("publish");
        var port = rtspPortMap.get(rtspUrl);
        if(port == null || port == undefined || port == ""){
            defaultPort = defaultPort + 1;
            port = defaultPort;
        }
        var src = "videoSourceRtspInClass.html?vid=" + vid + "&userName=" + nick + "&wsPort=" + port + "&rtspUrl=" + rtspUrl+"&publish="+publish+"&userId="+teacherId+"&from="+from+"&audioDeviceId="+audioDeviceId;
        $("#video_sources").append("<div class='videoSource_content-video'><div class='videoSource_content-video-left'><iframe src='" + src + "'></iframe></div><span class='videoSource_content-video-right' onclick='deleteVideoSource(this);'><i></i>关闭视频源</span></div>");
    }

    function addUsingIpCameraInfo(userName,rtspUrl,audioDeviceId){
        var device = {};
        device.type = "ipCamera";
        device.rtspUrl = ""+rtspUrl;
        device.audioDeviceId = audioDeviceId;
        device.userName = userName;
        var savedList = JSON.parse(localStorage.getItem("usingDeviceList_"+from));
        if(savedList == null || savedList == undefined || !(savedList instanceof Array)){
            savedList = [];
        }
        savedList.push(device);
        localStorage.setItem("usingDeviceList_"+from,JSON.stringify(savedList));
    }

    function preView() {
        var videoDeviceId = $("[name='videoinput']").filter(":checked").val();
        var audioDeviceId = $("[name='audioinput']").filter(":checked").val();
        if (typeof (videoDeviceId) == "undefined") {
            layer.msg("请选择视频设备~~");
            return;
        }
        var audioSource = audioDeviceId;
        var videoSource = videoDeviceId;
        var constraints = {
            audio: { deviceId: audioSource ? { exact: audioSource } : undefined },
            video: { deviceId: videoSource ? { exact: videoSource } : undefined }
        };
        navigator.mediaDevices.getUserMedia(constraints).
            then(function (stream) {
                $("#preview_video")[0].srcObject = stream;
            }).catch(function (e) {
                console.log(e);
            });
    }

    function useInclass() {
        var videoDeviceId = $("[name='videoinput']").filter(":checked").val();
        var audioDeviceId = $("[name='audioinput']").filter(":checked").val();
        var nick = $("#nick").val();
        if (typeof (nick) == "undefined" || nick == "") {
            layer.msg("请输入此设备在课堂中的昵称~~");
            return;
        }
        layer.closeAll();
        addUsingUsbCameraInfo(videoDeviceId,audioDeviceId,nick);
        innerUseUsbCamera(videoDeviceId,audioDeviceId,nick);
    }

    function innerUseUsbCamera(videoDeviceId,audioDeviceId,nick){
        var publish = Service.getQueryString("publish");
        var src = "videoSourceInClass.html?videoDeviceId=" + videoDeviceId + "&audioDeviceId=" + audioDeviceId + "&vid=" + vid + "&userName=" + nick+"&publish="+publish+"&userId="+teacherId+"&from="+from;
        $("#video_sources").append("<div class='videoSource_content-video'><div class='videoSource_content-video-left'><iframe src='" + src + "'></iframe></div><span class='videoSource_content-video-right' onclick='deleteVideoSource(this);'><i></i>关闭视频源</span></div>");
    }

    function deleteVideoSource(span) {
        var iframe = $(span).parent().find("iframe")[0];
        iframe.contentWindow.unpublish();
        setTimeout(function () {
            $(span).parent().remove();
        }, 100);
    }

    function addUsingUsbCameraInfo(videoDeviceId,audioDeviceId,userName){
        var device = {};
        device.type = "usbCamera";
        device.videoDeviceId = ""+videoDeviceId;
        device.audioDeviceId = ""+audioDeviceId;
        device.userName = userName;
        var savedList = JSON.parse(localStorage.getItem("usingDeviceList_"+from));
        if(savedList == null || savedList == undefined || !(savedList instanceof Array)){
            savedList = [];
        }
        savedList.push(device);
        localStorage.setItem("usingDeviceList_"+from,JSON.stringify(savedList));
    }

    function addScreen(){
        var childrenSize = $("#video_sources").children().length;
        if(from == "slaver" &&childrenSize > 1){
            layer.msg("请先移除已添加视频源");
            return;
        }
        var html = "<div class='list-content'><div class='list-item'><span class='left'>课堂昵称</span><div class='inputWrap'><input id='layer_screen_nick' class='right nickname'/></div></div><div class='list-item list-item-video'><video id='layer_screen_video' width='229' height='161' autoplay muted></video></div></div><div class='btn-cont'><span onclick='layer.closeAll();' class='btn-blue Ghost-btn'>取消</span><span id='layer_screen_preview' onclick='screenVideoPreview();' class='btn-blue Solid-btn'>预览</span><span onclick='useScreenVideoInclass();' class='btn-blue Solid-btn'>使用</span></div>";
        layer.open({
            type: 1,
            title: "桌面视频源",
            closeBtn: 0,
            skin: "videoSource",
            area: ['100%', '480px'], //宽高
            offset: 'b',
            content: html
        });
    }

    function useScreenVideoInclass(){
        var nick = $("#layer_screen_nick").val();
        if(typeof(nick) == "undefined" || nick == null || nick == ""){
            layer.msg("请输入昵称~~");
            return;
        }
        layer.closeAll();
        addUsingScreenInfo();
        innerUseScreenInclass(nick);
    }

    function innerUseScreenInclass(nick){
        var publish = Service.getQueryString("publish");
        var src = "screenVideoInClass.html?vid=" + vid + "&userName=" + nick+"&publish="+publish+"&userId="+teacherId+"&from="+from;
        $("#video_sources").append("<div class='videoSource_content-video'><div class='videoSource_content-video-left'><iframe src='" + src + "'></iframe></div><span class='videoSource_content-video-right' onclick='deleteVideoSource(this);'><i></i>关闭视频源</span></div>");
    }

    function addUsingScreenInfo(){
        var device = {};
        device.type = "screen";
        var savedList = JSON.parse(localStorage.getItem("usingDeviceList_"+from));
        if(savedList == null || savedList == undefined || !(savedList instanceof Array)){
            savedList = [];
        }
        savedList.push(device);
        localStorage.setItem("usingDeviceList_"+from,JSON.stringify(savedList));
    }

    function screenVideoPreview(){
        const constraints = {
           audio: {
               mandatory: {
                   chromeMediaSource: 'desktop'
               }
           },
            video: {
                mandatory: {
                    chromeMediaSource: 'desktop',
                    maxWidth:1280,
                    minWidth:1280,
                    maxHeight:720,
                    minHeight:720,
                    maxFrameRate:30,
                    minFrameRate:30
                }
            }
        };

        navigator.mediaDevices.getUserMedia(constraints)
            .then(function(stream){
                document.getElementById("layer_screen_video").srcObject = stream;
            })
            .catch(function(e){
                console.log(e);
            });
    }

    function init(){
        var from = Service.getQueryString("from");
        if(from == "master"){
            $("#screen_menu").show();
        }
        var savedList = JSON.parse(localStorage.getItem("usingDeviceList_"+from));
        if(savedList){
            savedList.forEach(function(device){
                var type = device.type;
                if(type == "usbCamera"){
                    innerUseUsbCamera(device.videoDeviceId,device.audioDeviceId,device.userName);
                }else if(type == "ipCamera"){
                    var audioDeviceId = "";
                    if(device.audioDeviceId){
                        audioDeviceId = device.audioDeviceId;
                    }
                    innerUseIpCamera(device.userName,device.rtspUrl,audioDeviceId);
                }else if(type == "screen"){
                    innerUseScreenInclass("桌面");
                }
            });
        }
    }

    $(document).ready(function(){
        setTimeout(function(){
            init();
        },500);
    });
</script>

</html>