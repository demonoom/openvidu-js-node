<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>课堂中的视频源</title>
    <link rel="icon" href="img/logo_title.png" type="image/x-icon">
    <link type="text/css" rel="stylesheet" href="css/record_list.css?v=35" />
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/hashmap.js"></script>
    <script type="text/javascript" src="js/layer/layer.js"></script>
    <script type="application/javascript" src="../openvidu-browser-2.6.0.js"></script>
    <script type="text/javascript" src="../ExRTCSDK-2.4.0.js"></script>
    <script type="text/javascript" src="js/service.js"></script>
    <script type="application/javascript" src="https://jsmpeg.com/jsmpeg.min.js"></script>
    <script type="text/javascript" src="js/MultiStreamsMixer.js"></script>
    <script type="text/javascript" src="js/rtsp_ffmpeg_config.js"></script>
    <script type="application/javascript" src="./webrtc-streamer/webrtcstreamer.js"></script>
    <script type="application/javascript" src="./webrtc-streamer/adapter.min.js"></script>
    <script type="application/javascript" src="./webrtc-streamer/request.min.js"></script>
    <script type="application/javascript" src="./js/AppUtils.js"></script>

    <style type="text/css">
        .layui-layer-shade{
            opacity: 0 !important;
        }
        .layui-layer{
            box-shadow: 0px 6px 50px rgba(0,0,0,0.4) !important;
        }
        .layer-anim{
            animation:none !important;
        }
        #rtsp_preview_canvas{
            width: 100%;
            height:100%;
            object-fit: cover;
        }
    </style>

</head>
<body>

<div class="videoSourceInClass-video" id="rtsp_preview_container">
    <canvas width="848px" height="480px" autoplay id="rtsp_preview_canvas"></canvas>
    <span class="preview_videoName til_hidden" id="video_name"></span>
</div>

</body>

<script type="text/javascript">
    var client = new ExRTC();
    var localStream;
    var jsmepgPlayer = null;

    var vid = Service.getQueryString("vid");
    var userName = Service.getQueryString("userName");
    var rtspUrl = Service.getQueryString("rtspUrl");
    var wsPort = Service.getQueryString("wsPort");
    var from = Service.getQueryString("from");
    var userId = Service.getQueryString("userId");
    userId = from=="master"?random(-10000000,-20000000):userId;

    var audioDeviceId = Service.getQueryString("audioDeviceId");

    audioDeviceId = (audioDeviceId == null || audioDeviceId == undefined || audioDeviceId == "")?false:audioDeviceId;

    var ipc = window.top.require('electron').ipcRenderer;

    var webRtcServer = null;

    $(document).ready(function(){
        $("#video_name").text(userName+"-网络摄像头");
        var publish = Service.getQueryString("publish");
        if(publish == "true"){
            joinRoom();
        }else{
            // var canvas = $("#rtsp_preview_canvas")[0];
            // if(jsmepgPlayer == null){
            //     jsmepgPlayer = new JSMpeg.Player('ws://localhost:'+wsPort,{loop: true, autoplay: true,canvas:canvas,audio :false});
            //
            //     var message = {};
            //     message.command = "startRtspStream";
            //     message.streamUrl = rtspUrl;
            //     message.wsPort = wsPort;
            //     message.fenbianlv = RtspFFMPEGConfig.fenbianlv;
            //     message.malv = RtspFFMPEGConfig.malv;
            //     message.zhenlv = RtspFFMPEGConfig.zhenlv;
            //     ipc.send('onRendererMessage',message);
            // }
            //用于未被连麦时候的提示
            $("#rtsp_preview_canvas").remove();
            $("#not_lianmai_tip").remove();
            $("#rtsp_preview_container").append("<div id='not_lianmai_tip' class='not_lianmai_tip'><span>等待被连麦</span><span onclick='parentOnlyPreviewRtsp();' class='not_lianmai_view'>预览</span></div>");
        }
    });

    function publish(){
        var service = new Service();
        var data = {};
        data.method = "applyRtspRepublishStream";
        data.macAddress = AppUtils.getMacAddress();
        data.rtspUrl = rtspUrl;
        //获取转推地址
        service.doWebService(data,{
            onResponse : function(result) {
                if(!result.success){
                    $("#rtsp_preview_canvas").remove();
                    $("#aplly_failed_tip").remove();
                    $("#rtsp_preview_container").append("<div id='aplly_failed_tip' class='not_lianmai_tip'><span>申请流地址失败，请稍后重试</span></div>");
                    return;
                }
                var stream = result.response;
                if(stream == null){
                    $("#rtsp_preview_canvas").remove();
                    $("#aplly_failed_tip").remove();
                    $("#rtsp_preview_container").append("<div id='aplly_failed_tip' class='not_lianmai_tip'><span>申请流地址失败，请稍后重试</span></div>");
                }else{
                    var message = {};
                    message.command = "rtspRepublish";
                    message.rtspUrl = rtspUrl;
                    message.stream = stream;
                    ipc.send('onRendererMessage',message);
                    webrtcStreamerGetStream(stream);
                }
            },
            onError : function(error) {
                $("#rtsp_preview_canvas").remove();
                $("#aplly_failed_tip").remove();
                $("#rtsp_preview_container").append("<div id='aplly_failed_tip' class='not_lianmai_tip'><span>申请流地址失败，请稍后重试</span></div>");
            }
        });
    }

    function parentOnlyPreviewRtsp(){
        window.parent.onlyPreviewRtsp(rtspUrl);
    }

    function webrtcStreamerGetStream(stream){
        $("#rtsp_preview_canvas").remove();
        $("#rtsp_preview_container").append("<video id='rtsp_preview_canvas' muted autoplay width='848px' height='480px'></video>");


        var options = "rtptransport=udp&timeout=60";
        options += "&width=848&height=480";
        if(webRtcServer != null){
            webRtcServer.disconnect();
            webRtcServer = null;
        }
        webRtcServer = new WebRtcStreamer("rtsp_preview_canvas","https://files.maaee.com:8000");
        webRtcServer.connect(stream,undefined,options);
        var firstPlay = true;

        var videoElement = $("#rtsp_preview_canvas")[0];
        videoElement.onplaying = function() {
            if(!firstPlay){
                return;
            }
            localStream = videoElement.srcObject;
            firstPlay = false;
            mixMicStream(localStream,function(){
                client.publish(localStream,"agora_local");
            });
        };
    }

    function mixMicStream(tabStream,onfinish){

        var micConstraints = {
            audio: true,
            video: false
        };
        if(audioDeviceId){
            micConstraints = {
                audio: {deviceId: audioDeviceId ? {exact: audioDeviceId} : undefined},
                video: false
            };
        };
        navigator.mediaDevices.getUserMedia(micConstraints).then(function(micStream) {
            var cts = {
                autoGainControl:true,//自动增益控制
                noiseSuppression:true,//噪声抑制
                echoCancellation:true//回声消除
            };

            var audioTracks = micStream.getAudioTracks();
            try{
                if(audioTracks && audioTracks.length && audioTracks.length > 0){
                    var audioTrack = audioTracks[0];
                    audioTrack.applyConstraints(cts);
                }
            }catch (e){

            }

            var speakers = new MediaStream();
            tabStream.getAudioTracks().forEach(function(track) {
                speakers.addTrack(track);
                tabStream.removeTrack(track);
            });

            var mixer = new MultiStreamsMixer([speakers, micStream]);
            mixer.getMixedStream().getAudioTracks().forEach(function(track) {
                tabStream.addTrack(track);
            });
            onfinish();
        }).catch(function(err) {
            console.log(err);
            onfinish();
        });
    }

    function unpublish(){
        if(webRtcServer != null){
            webRtcServer.disconnect();
            webRtcServer = null;
        }
        if(jsmepgPlayer != null){
            jsmepgPlayer.destroy();
            jsmepgPlayer = null;
        }
        try{
            client.unpublish(localStream);
            localStream.close();
        }catch(e){
            console.log(e);
        }
        localStream = null;

        var message = {};
        message.command = "stopRtspStream";
        message.wsPort = wsPort;
        ipc.send('onRendererMessage',message);

        var msg = {};
        msg.command = "stopRtspRepublish";
        msg.rtspUrl = rtspUrl;
        ipc.send('onRendererMessage',msg);

        removeIpCameraInfo();
    }

    function removeIpCameraInfo(){
        var savedList = JSON.parse(localStorage.getItem("usingDeviceList_new_"+from));

        if(savedList){
            var tobeDeleteIndex = -1;
            savedList.forEach(function(device,index){
                if(device.type == "ipCamera" && device.rtspUrl == rtspUrl && device.userName == userName){
                    tobeDeleteIndex = index;
                }
            });
            if(tobeDeleteIndex >= 0){
                savedList.splice(tobeDeleteIndex,1);
            }
            localStorage.setItem("usingDeviceList_new_"+from,JSON.stringify(savedList));
        }
    }

    function random(lower, upper) {
        return Math.floor(Math.random() * (upper - lower+1)) + lower;
    }

    function joinRoom(){
        console.log('joinRoom .....');
        client = new ExRTC();

        client.join(vid+"", userId,userName, function() {
            console.log('joinRoom success');
            publish();
        }, function() {
            console.log("Join channel failed");
        });
    }

</script>

</html>