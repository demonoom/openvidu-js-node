<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>课堂手机助手</title>
    <link href="css/classMobileAssistant.css" type="text/css" rel="stylesheet" />
    <script type="application/javascript" src="js/jquery-1.11.2.min.js"></script>
    <script type="application/javascript" src="js/layer/layer.js"></script>
    <script type="application/javascript" src="js/service.js"></script>
</head>
<body>
    <div id="empty">
    暂无打开的课件
    </div>


    <div id="pushTopic">
    题库
    </div>

    <div class="topic_box">
        <div style="position: relative;">
                <div class="topic_nav">
                    <div class="nav_text">

                    </div>
                    <div class="nav_close">X</div>
                </div>
                <div class="topic_body">
                     <div class="topic_list">

                     </div>
                     <div class="topic_more" onclick="getMoreTopic()">点击加载更多</div>
                </div>
                <div class="pushTopic" onclick="pushTopic()">推送题目</div>
        </div>

    </div>

          <div id="iframeBox" style="overflow: auto;-webkit-overflow-scrolling:touch;width:100%;"></div>
          <div class="courseware-open" onclick="showAddAttachment()">
            <span>课件</span>
          </div>
          <div class="attachment_box" id="attachment_box">
            <div class="navigate">
              <div class="nav text-hidden" id="nav"></div>
              <div onclick="clickMask()" class="nav-back"></div>
            </div>
            <div class="attachment-cont">
              <div class="attachment_list" id="attachment_list"></div>
              <div onclick="onEndedPage(event)" id="attachment_bottom" class='attachment_bottom'>加载更多</div>
            </div>
          </div>
          <div class="mask" id="mask" onclick="clickMask()"></div>

</body>

<script src="./js/simple_websocket_connection.js" type="text/javascript"></script>
<script>
//   var userId = 28551;
//   vid = 221822;
   var vid = Service.getQueryString("vid");
   var userId = Service.getQueryString("userId");
   var HTML_LIST="";
   var simpleMS = new SimpleConnection();
   var randomNumber = RandomNumBoth(1000000,2000000);
   var defaultPageNo = 1;
   var parentId = -1;
   var parentArray = [{
       id: -1,
       name: '蚁盘'
   }];
   var parentTopicArray = [{
       id: -1,
       name:'蚁盘'
   }];
   var navHtml = '';
   var listHtml = '';
   var pageNo = 1;
   var topicId = -1;
   //推题数组
   var quesArr = [];

   var iframeBox = document.getElementById("iframeBox");
   var iframe = document.createElement("iframe");
   iframe.setAttribute("id","ifr");
   iframe.setAttribute("name","ifr");
   iframe.setAttribute("frameborder","0");
   iframe.setAttribute("scrolling","no");
   iframe.setAttribute("style","width: 1px; min-width: 100%; *width: 100%");
   iframeBox.appendChild(iframe);
   simpleMS.connect();
   getClassOpenedKejian(vid);
   filterCloudFile();
   //获取蚁盘文件根目录
   getUserRootCloudSubjects(userId,true);
//   listCloudSubject(cloudFileId,pageNo);
   //监听
   simpleMS.msgWsListener = {
        onError: function (errorMsg) {
          }, onWarn: function (warnMsg) {
          }, onMessage: function (info) {
             console.log(info,'info');
             if(info.command == 'pushTopicInAssistant'){
                 layer.msg('推送成功');
             }
          }
        };

    function getMoreTopic(){
        if($('.topic_more').text() == '已全部加载'){
            return;
        }else{
            quesArr.splice(0);
            if(parentTopicArray.length > 1){
               console.log('获取更多文件在子目录');
               pageNo++;
               listCloudSubject(topicId);
            }else{
               console.log('获取更多文件在根目录');
               pageNo++;
               getUserRootCloudSubjects(userId);
            }
        }

    }

    function pushTopic(){
        if(quesArr.length <= 0){
            layer.msg("请先选中要推送的题目");
        }else{
            var protocal = eval('(' + "{'command':'pushTopicInAssistant','data':{'sids':'"+quesArr.join(',')+"'}}" + ')');
            simpleMS.send(protocal);
        }
    }


    function topicClickFolder(id,name){
//        console.log(id);
//        console.log(name);
//        console.log('文件夹');
        quesArr.splice(0);
        pageNo = 1;
        parentTopicArray.push({
              id:id,
              name:name
        });
        navHtml = '';
        listHtml = '';
        topicId = id;
        listCloudSubject(id,true);
    }

    function checkboxOnchange(e,id){
        console.log(e);
        console.log(id);
        if (e.checked) {
                quesArr.push(id)
        } else {
                quesArr = quesArr.filter((res) => {
                    return res != id
                })
        }
        console.log(quesArr,'quesArr');

    }


//点击推送题目
    $('#pushTopic').on('click',function(){
//        console.log('推送题目');
        $('.topic_box').css({transform:'translate(0%,0%)'});
        $('.mask').css({display:'block'});

    });

       /*
       根据文件夹id获取蚁盘题目根目录
        */
       function getUserRootCloudSubjects(uId,isNav){
           var service = new Service();
           var data = {
               method:'getUserRootCloudSubjects',
               userId: uId,
               pageNo:pageNo
           };
           service.doWebService(data,{
               onResponse:(res) => {
                   console.log(res,'蚁盘题目根目录');
                   if(res.success && res.response){
                       var response = res.response;
                       //导航栏
                       if(isNav){
                           for(var k in parentTopicArray){
                                   navHtml += "<span><span onclick='nav_topic(\""+parentTopicArray[k].id+"\","+k+")'>"+parentTopicArray[k].name+"</span><span>></span></span>";
                           }
                           $('.nav_text').html(navHtml);
                       }
                       for(var k in response){
                           console.log(response[k].fileType,'');
                           if(response[k].fileType == 1){ //文件夹
                               listHtml += "<div onclick='topicClickFolder("+response[k].id+",\""+response[k].name+"\")'> <img src='./img/cloud_icon_web.png' alt=''> <span>"+response[k].name+"</span> </div>";
                           }else if(response[k].fileType == 2){ // 题目
                               listHtml += "<div><div class='topic_item'><img src='./img/cloud_icon_web1.png' alt=''><div>"+response[k].name+"</div></div> <input type='checkbox' onclick='checkboxOnchange(this," + response[k].subject.id + ")'> </div>";
                           }
                       }
                       if(response.length <= 0){
                           $('.topic_more').text('已全部加载');
                       }else{
                           $('.topic_more').text('点击加载更多');
                       }
                       $('.topic_list').html(listHtml);
                   }else{

                   }
               },
               onError:function(error){}
           });
       }


       function nav_topic(id,index){
//           console.log(index,'index');
           navHtml = '';
           listHtml = '';
           topicId = id;
           pageNo = 1;
           quesArr.splice(0);
           parentTopicArray = parentTopicArray.splice(0,index+1);

           if(id == -1){//根目录
               getUserRootCloudSubjects(userId,true);
//               console.log(parentTopicArray,'parentTopicArray');
           }else{ //子目录

               listCloudSubject(id,true);
           }
       }

       /*
       根据文件夹id获取蚁盘题目
        */
       function listCloudSubject(cId,isNav){
           var service = new Service();
           var data = {
               method:'listCloudSubject',
               cloudFileId: cId,
               pageNo:pageNo
           };
           service.doWebService(data,{
               onResponse:(res) => {
                   console.log(res,'蚁盘题目');
                   if(res.success && res.response){
                       var response = res.response;
                       //导航栏
                       if(isNav){
                           for(var k in parentTopicArray){
                                   navHtml += "<span><span onclick='nav_topic(\""+parentTopicArray[k].id+"\","+k+")'>"+parentTopicArray[k].name+"</span><span>></span></span>";
                           }
                           $('.nav_text').html(navHtml);
                       }
                       for(var k in response){
                           console.log(response[k].fileType,'');
                           if(response[k].fileType == 1){ //文件夹
                               listHtml += "<div onclick='topicClickFolder("+response[k].id+",\""+response[k].name+"\")'> <img src='./img/cloud_icon_web.png' alt=''> <span>"+response[k].name+"</span> </div>";
                           }else if(response[k].fileType == 2){ // 题目
                               listHtml += "<div><div class='topic_item'>"+response[k].name+"</div> <input type='checkbox' onclick='checkboxOnchange(this," + response[k].subject.id + ")'> </div>";
                           }
                       }
                       if(response.length <= 0){
                           $('.topic_more').text('已全部加载');
                       }else{
                           $('.topic_more').text('点击加载更多');
                       }
                       $('.topic_list').html(listHtml);
                   }else{

                   }
               },
               onError:function(error){}
           });
       }

   /*
   通过vid获取课件信息
    */
   function getClassOpenedKejian(vid){
       var service = new Service();
       var data = {
           method:'getVclassPPTOpenInfo',
           vid: vid
       };
       service.doWebService(data,{
           onResponse:(res) => {
               console.log(res,'success');
               if(res.success && res.response){
                   document.getElementById('empty').style.display="none";
                   document.getElementById('iframeBox').style.display="block";
                   iframe.setAttribute("src","https://www.maaee.com/Excoord_For_Education/drawboard/main_app.html?vid="+res.response.vid+"&userId="+randomNumber+"&role=manager&ppt="+res.response.pptUrl+"");
//                   setTimeout(()=>{
//                           var progress_bar_container = window.frames["ifr"].document.getElementById("progress_bar_container");
//                           var progress_bar_wrap = window.frames["ifr"].document.getElementsByClassName("progress_bar_wrap")[0];
//                           progress_bar_wrap.style.borderRadius = "0 0 4px 4px";
//                           progress_bar_container.style.top = 0;
//                   },1000);

                   setTimeout(()=>{
//                       iframe.contentWindow.pptCheckPage(res.response.currentPage);
                         window.frames['ifr'].window.pptCheckPage(res.response.currentPage)
                   },2000);

//                   if(iframe.contentWindow.pptCheckPage){

//                   }
               }else{
                   document.getElementById('empty').style.display="block";
                   document.getElementById('iframeBox').style.display="none";
               }
           },
           onError:function(error){}
       });
   }

   /*
   * 生成随机数
    */
   function RandomNumBoth(Min,Max){
         var Range = Max - Min;
         var Rand = Math.random();
         var num = Min + Math.round(Rand * Range); //四舍五入
         return num;
   }

   /*
   点击蚁盘文件触发事件
   */
   function clickFile(fileType,parent,name,isPush,suffix,htmlPath,pdfPath){
       var path = suffix == 'ppt' || suffix == "pptx"?htmlPath:pdfPath;
       name = unescape(name);
       if(fileType==0){
           if(path && path != 'null'){
               var iframe = document.getElementById("ifr");
               var newHTMLPath = path.replace("http://60.205.86.217","https://www.maaee.com");
               newHTMLPath = newHTMLPath.replace("http://60.205.111.227","https://www.maaee.com");
               iframe.setAttribute("src","https://www.maaee.com/Excoord_For_Education/drawboard/main_app.html?vid="+vid+"&userId="+randomNumber+"&role=manager&ppt="+newHTMLPath+"");
               var protocal = eval('(' + "{'command':'assistantPlayKejian','data':{'roomid':'"+vid+"','html':'"+newHTMLPath+"','userId':'"+userId+"'}}" + ')');
               //推送通知
               simpleMS.send(protocal);
               AddAttachmentChange('none');
               document.getElementById('empty').style.display="none";
               document.getElementById('iframeBox').style.display="block";
           }else{
              console.log("path为空");
           }
       }else{
           parentId = parent;
           if(isPush){
               parentArray.push({
                    id: parent,
                    name: name
               });
           }
           filterCloudFile(true);
       }
   }

   /*
      * 根据userId获取蚁盘文件
       */
   function filterCloudFile(clearFlag){
       if(clearFlag){
       HTML_LIST = '';
       defaultPageNo = 1;
       document.getElementById('attachment_bottom').innerText= "点击加载更多";
       }
       var service = new Service();
       var data = {
           method:'filterCloudFile',
           userId: userId,
           parentId: parentId,
           filterOption: -17,
           pageNo: defaultPageNo,

       };
       service.doWebService(data,{
           onResponse:(res) => {
               console.log(res,'filterCloudFile');
               if(res.success){
                   var attachment_list = document.getElementById('attachment_list');
                   var attachment_bottom = document.getElementById('attachment_bottom');
                   var nav = document.getElementById('nav');
                   var data = res.response;
                   var imgSrc,img_height;
                   for(var k in data){
                           imgSrc = data[k].fileType == 0?"./img/cloud_icon_web1.png":"./img/cloud_icon_web.png";
                           img_height = data[k].fileType == 0?30:20;
                           HTML_LIST += "" +
                            "<div onclick=clickFile("+data[k].fileType+","+data[k].id+",\""+escape(data[k].name)+"\",true,\""+data[k].suffix+"\",\""+data[k].htmlPath+"\",\""+data[k].pdfPath+"\") class='list-item line_public'><img class='item-image' src="+imgSrc+" style='height:"+img_height+"px' /><span class='item-text text-hidden'>"+data[k].name+"</span></div>";
                   }
                   var navHTML = "";
                   nav.innerHTML = "";
                   for(var k in parentArray){
                       navHTML += "<span onclick=clickNav("+parentArray[k].id+",\""+parentArray[k].name+"\") >"+parentArray[k].name+" > </span>";
                   }
                   attachment_bottom.innerText = res.response.length <= 0?"无更多文件":"点击加载更多";;
                   attachment_list.innerHTML = (HTML_LIST);
                   nav.innerHTML = navHTML;
               }
           },
           onError:function(error){
               console.log(error,'error');
           }
       });
   }


   //点击导航栏事件
   function clickNav(parentId,parentName){
       var indexof = '';
       for(var k in parentArray){
           if(parentArray[k].id == parentId){
               indexof = parseInt(k)+1;
           }
       }
       parentArray = parentArray.slice(0,parseInt(indexof));
       clickFile(1,parentId,parentName);
   }

   //加载更多
   function onEndedPage(e){
       if(e.srcElement.innerText == "无更多文件"){
           return;
       }
       defaultPageNo += 1;
       filterCloudFile();
   }

   //点击遮罩
   function clickMask(){
       AddAttachmentChange('none');
       $('.topic_box').css({transform:'translate(0%,100%)'});
   }

   //点击添加按钮
   function showAddAttachment(){
       AddAttachmentChange('block');
   }

   //改变蚁盘元素显示状态
   function AddAttachmentChange(style){
       var mask = document.getElementById('mask');
       var attachment_box = document.getElementById('attachment_box');
       mask.style.display = style;
       attachment_box.style.display = style;
       window.requestAnimationFrame(function(){
          attachment_box.style.transform = style == 'block'?"translateY(0%)":"translateY(100%)";
       })


   }
</script>
</html>