<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>课堂手机助手</title>
    <link href="css/classMobileAssistant.css" type="text/css" rel="stylesheet" />
    <script type="application/javascript" src="js/jquery-1.11.2.min.js"></script>
    <script type="application/javascript" src="js/layer/layer.js"></script>
    <script type="application/javascript" src="js/service.js"></script>
</head>
<body>
    <div id="empty">
    暂无打开的课件
    </div>

    <div id="pushTopic">
    题库
    </div>

    <div id="album">
    选图
    </div>

    <div id="shouTu">收图</div>

    <div class="imageBox">
        <img id="image" src="http://img3.redocn.com/tupian/20150908/sansuitaoxinbiankuang_3797288.jpg" alt="">
        <div class="pushImage-navigation">
            <div class="close_img" onclick="closeImage()">关闭</div>
            <button class="pushImageBtn" onclick="pushImage()">推图</button>
        </div>
    </div>


    <div class="topic_box">
        <div class="topic_nav">
            <div class="nav_text text-hidden">

            </div>
            <div class="nav_close" onclick="clickMask()"></div>
        </div>
        <div class="topic_body">
            <div class="topic_list">

            </div>
            <div class="topic_more" onclick="getMoreTopic()">点击加载更多</div>
        </div>
        <div class="pushTopic" onclick="pushTopic()"><div>推送<br/>题目</div></div>
    </div>

          <div id="iframeBox" style="overflow: auto;-webkit-overflow-scrolling:touch;width:100%;"></div>
          <div class="courseware-open" onclick="showAddAttachment()">
            <span>课件</span>
          </div>
          <div class="attachment_box" id="attachment_box">
            <div class="navigate">
              <div class="nav text-hidden" id="nav"></div>
              <div onclick="clickMask()" class="nav-back"></div>
            </div>
            <div class="attachment-cont">
              <div class="attachment_list" id="attachment_list"></div>
              <div onclick="onEndedPage(event)" id="attachment_bottom" class='attachment_bottom'>加载更多</div>
            </div>
          </div>
          <div class="mask" id="mask" onclick="clickMask()"></div>

</body>

<script src="./js/clazz_websocket_connection.js"></script>
<script src="./js/layer/layer.js"></script>
<script src="https://res.wx.qq.com/open/js/jweixin-1.3.0.js"></script>
<script>

   var vid = Service.getQueryString("vid");
   var userId = Service.getQueryString("userId");
   var HTML_LIST="";
   var clazzConn = new ClazzConnection();
   var randomNumber = RandomNumBoth(1000000,2000000);
   var defaultPageNo = 1;
   var parentId = -1;
   var parentArray = [{
       id: -1,
       name: '蚁盘'
   }];
   var parentTopicArray = [{
       id: -1,
       name:'蚁盘'
   }];
   var navHtml = '';
   var listHtml = '';
   var pageNo = 1;
   var topicId = -1;
   //推题数组
   var quesArr = [];
   var isCheckPage = true;

   var iframeBox = document.getElementById("iframeBox");
   var iframe = document.createElement("iframe");
   var picUrl = "http://img3.redocn.com/tupian/20150908/sansuitaoxinbiankuang_3797288.jpg";
var loginPro = {
    "command": "assistantLogin",
    "data": {
        "vid": vid,
        "userId": userId
    }
};
   $(function(){
          iframe.setAttribute("id","ifr");
          iframe.setAttribute("name","ifr");
          iframe.setAttribute("frameborder","0");
          iframe.setAttribute("scrolling","no");
          iframe.setAttribute("style","width: 1px; min-width: 100%; *width: 100%");
          iframeBox.appendChild(iframe);
          clazzConn.connect(loginPro);

          //获取微信签名
          getWeChatSignature();
          getClassOpenedKejian(vid);
          filterCloudFile();
          //获取蚁盘文件根目录
          getUserRootCloudSubjects(userId,true);
   });

   //监听
   clazzConn.clazzWsListener = {
        onError: function (errorMsg) {
            console.error(errorMsg);
            layer.msg(errorMsg);
          }, onWarn: function (warnMsg) {
            console.warn(warnMsg);
          }, onMessage: function (info) {
             if(info.command == 'pushSubjecShowContentUrl'){
                     layer.msg('推题成功');
             }else if(info.command == 'class_ppt'){ //更换课件
                 if(info.data.html){
                    checkIframe(info.data.html,true);
                 }
             }else if(info.command == 'assistantLogin'){ //登录
                          layer.msg('已登入!',{time: 500});
             }else if(info.command == "pushHandout"){
                     layer.msg('推图成功',{time: 500});
//                 }
             }
          }
   };


    function getMoreTopic(){
        if($('.topic_more').text() == '已全部加载'){
            return;
        }else{
            quesArr.splice(0);
            if(parentTopicArray.length > 1){
               console.log('获取更多文件在子目录');
               pageNo++;
               listCloudSubject(topicId);
            }else{
               console.log('获取更多文件在根目录');
               pageNo++;
               getUserRootCloudSubjects(userId);
            }
        }

    }

    function pushTopic(){
        if(quesArr.length <= 0){
            layer.msg("请先选中要推送的题目");
        }else{
            var protocal = eval('(' + "{'command':'pushSubjecShowContentUrl','data':{'sids':'"+quesArr.join(',')+"'}}" + ')');
            clazzConn.send(protocal);
        }
    }


    function topicClickFolder(id,name){
        quesArr.splice(0);
        pageNo = 1;
        parentTopicArray.push({
              id:id,
              name:name
        });
        navHtml = '';
        listHtml = '';
        topicId = id;
        listCloudSubject(id,true);
    }

    function checkboxOnchange(e,id){
        $(e).prev().toggleClass('active');
        if (e.checked) {
                quesArr.push(id)
        } else {
                quesArr = quesArr.filter((res) => {
                    return res != id
                })
        }
        console.log(quesArr,'quesArr');

    }


//点击题目
    $('#pushTopic').on('click',function(){
        $('.mask').css({display:'block'});
        $('.topic_box').css({display:'block'});
        window.requestAnimationFrame(function(){
            $('.topic_box').css({transform:'translate(0%,0%)'});
        });
    });

       /*
       根据文件夹id获取蚁盘题目根目录
        */
       function getUserRootCloudSubjects(uId,isNav){
           var service = new Service();
           var data = {
               method:'getUserRootCloudSubjects',
               userId: uId,
               pageNo:pageNo
           };
           service.doWebService(data,{
               onResponse:(res) => {
                   if(res.success && res.response){
                       var response = res.response;
                       //导航栏
                       if(isNav){
                           for(var k in parentTopicArray){
                                   if(navHtml == ''){
                                       navHtml += "<span><span onclick='nav_topic(\""+parentTopicArray[k].id+"\","+k+")'>"+parentTopicArray[k].name+"</span></span>";
                                   }else{
                                       navHtml += "<span> <span> > </span> <span onclick='nav_topic(\""+parentTopicArray[k].id+"\","+k+")'>"+parentTopicArray[k].name+"</span></span>";
                                   }
                           }
                           $('.nav_text').html(navHtml);
                       }
                       for(var k in response){
//                           console.log(response[k].fileType,'');
                           if(response[k].fileType == 1){ //文件夹
                               listHtml += "<div class='line_public' onclick='topicClickFolder("+response[k].id+",\""+response[k].name+"\")'> <img class='item-image' src='./img/cloud_icon_web.png' alt=''> <span class='item-text text-hidden'>"+response[k].name+"</span> </div>";
                           }else if(response[k].fileType == 2){ // 题目
                               listHtml += "<div class='line_public quesItem'><div class='inputDiv'><i class='icon_check'></i><input type='checkbox' onclick='checkboxOnchange(this," + response[k].subject.id + ")'></div><div class='topic_item'>"+response[k].name+"</div></div>";
                           }
                       }
                       if(response.length <= 0){
                           $('.topic_more').text('已全部加载');
                       }else{
                           $('.topic_more').text('点击加载更多');
                       }
                       $('.topic_list').html(listHtml);
                   }else{

                   }
               },
               onError:function(error){}
           });
       }


       function nav_topic(id,index){
           navHtml = '';
           listHtml = '';
           topicId = id;
           pageNo = 1;
           quesArr.splice(0);
           parentTopicArray = parentTopicArray.splice(0,index+1);
           if(id == -1){//根目录
               getUserRootCloudSubjects(userId,true);
           }else{ //子目录

               listCloudSubject(id,true);
           }
       }

       /*
       根据文件夹id获取蚁盘题目
        */
       function listCloudSubject(cId,isNav){
           var service = new Service();
           var data = {
               method:'listCloudSubject',
               cloudFileId: cId,
               pageNo:pageNo
           };
           service.doWebService(data,{
               onResponse:(res) => {
                   if(res.success && res.response){
                       var response = res.response;
                       //导航栏
                       if(isNav){
                           for(var k in parentTopicArray){
                               if(navHtml == ''){
                                   navHtml += "<span><span onclick='nav_topic(\""+parentTopicArray[k].id+"\","+k+")'>"+parentTopicArray[k].name+"</span></span>";
                               }else{
                                   navHtml += "<span> <span> > </span> <span onclick='nav_topic(\""+parentTopicArray[k].id+"\","+k+")'>"+parentTopicArray[k].name+"</span></span>";
                               }
                                   // navHtml += "<span><span onclick='nav_topic(\""+parentTopicArray[k].id+"\","+k+")'>"+parentTopicArray[k].name+"</span><span>></span></span>";
                           }
                           $('.nav_text').html(navHtml);
                       }
                       for(var k in response){
                           console.log(response[k].fileType,'');
                           if(response[k].fileType == 1){ //文件夹
                               listHtml += "<div class='line_public' onclick='topicClickFolder("+response[k].id+",\""+response[k].name+"\")'> <img class='item-image' src='./img/cloud_icon_web.png' alt=''> <span class='item-text text-hidden'>"+response[k].name+"</span> </div>";
                           }else if(response[k].fileType == 2){ // 题目
                               listHtml += "<div class='line_public quesItem'><div class='inputDiv'><i class='icon_check'></i><input type='checkbox' onclick='checkboxOnchange(this," + response[k].subject.id + ")'></div><div class='topic_item'>"+response[k].name+"</div></div>";
                           }
                       }
                       if(response.length <= 0){
                           $('.topic_more').text('已全部加载');
                       }else{
                           $('.topic_more').text('点击加载更多');
                       }
                       $('.topic_list').html(listHtml);
                   }else{

                   }
               },
               onError:function(error){}
           });
       }

   /*
   通过vid获取课件信息
    */
   function getClassOpenedKejian(vid){
       var service = new Service();
       var data = {
           method:'getVclassPPTOpenInfo',
           vid: vid
       };
       service.doWebService(data,{
           onResponse:(res) => {
//               console.log(res,'success');
               if(res.success && res.response){
                   document.getElementById('empty').style.display="none";
                   document.getElementById('iframeBox').style.display="block";
                   iframe.setAttribute("src","https://www.maaee.com/Excoord_For_Education/drawboard/main_app.html?vid="+res.response.vid+"&userId="+randomNumber+"&role=manager&ppt="+res.response.pptUrl+"");
                   $(iframe).load(function(){    //  等iframe加载完毕
                       if(isCheckPage){
                          setTimeout(()=>{
                             window.frames['ifr'].window.pptCheckPage(res.response.currentPage);
                          },2000);
                          isCheckPage = false;
                       }
                   });
               }else{
                   document.getElementById('empty').style.display="block";
                   document.getElementById('iframeBox').style.display="none";
               }
           },
           onError:function(error){}
       });
   }

   /*
   * 生成随机数
    */
   function RandomNumBoth(Min,Max){
         var Range = Max - Min;
         var Rand = Math.random();
         var num = Min + Math.round(Rand * Range); //四舍五入
         return num;
   }

   /*
   点击蚁盘文件触发事件
   */
   function clickFile(fileType,parent,name,isPush,suffix,htmlPath,pdfPath){
       var path = suffix == 'ppt' || suffix == "pptx"?htmlPath:pdfPath;
       name = unescape(name);
       if(fileType==0){
           if(path && path != 'null'){
               checkIframe(path);
           }else{
              console.log("path为空");
           }
       }else{
           parentId = parent;
           if(isPush){
               parentArray.push({
                    id: parent,
                    name: name
               });
           }
           filterCloudFile(true);
       }
   }


   function checkIframe(path,flag){
       var iframe = document.getElementById("ifr");
       var newHTMLPath = path.replace("http://60.205.86.217","https://www.maaee.com");
       newHTMLPath = newHTMLPath.replace("http://60.205.111.227","https://www.maaee.com");
       iframe.setAttribute("src","https://www.maaee.com/Excoord_For_Education/drawboard/main_app.html?vid="+vid+"&userId="+randomNumber+"&role=manager&ppt="+newHTMLPath+"");
       if(!flag){
           var protocal = eval('(' + "{'command':'class_ppt','data':{'control':1,'html':'"+newHTMLPath+"','vid':'"+vid+"'}}" + ')');
           //推送通知
           clazzConn.send(protocal);
       }
       AddAttachmentChange('none');
       document.getElementById('empty').style.display="none";
       document.getElementById('iframeBox').style.display="block";
   }

   /*
      * 根据userId获取蚁盘文件
       */
   function filterCloudFile(clearFlag){
       if(clearFlag){
       HTML_LIST = '';
       defaultPageNo = 1;
       document.getElementById('attachment_bottom').innerText= "点击加载更多";
       }
       var service = new Service();
       var data = {
           method:'filterCloudFile',
           userId: userId,
           parentId: parentId,
           filterOption: -17,
           pageNo: defaultPageNo,

       };
       service.doWebService(data,{
           onResponse:(res) => {
//               console.log(res,'filterCloudFile');
               if(res.success){
                   var attachment_list = document.getElementById('attachment_list');
                   var attachment_bottom = document.getElementById('attachment_bottom');
                   var nav = document.getElementById('nav');
                   var data = res.response;
                   var imgSrc,img_height;
                   for(var k in data){
                           imgSrc = data[k].fileType == 0?"./img/cloud_icon_web1.png":"./img/cloud_icon_web.png";
                           img_height = data[k].fileType == 0?30:20;
                           HTML_LIST += "" +
                            "<div onclick=clickFile("+data[k].fileType+","+data[k].id+",\""+escape(data[k].name)+"\",true,\""+data[k].suffix+"\",\""+data[k].htmlPath+"\",\""+data[k].pdfPath+"\") class='list-item line_public'><img class='item-image' src="+imgSrc+" style='height:"+img_height+"px' /><span class='item-text text-hidden'>"+data[k].name+"</span></div>";
                   }
                   var navHTML = "";
                   nav.innerHTML = "";
                   for(var k in parentArray){
                       if(k == 0){
                           navHTML += "<span onclick=clickNav("+parentArray[k].id+",\""+parentArray[k].name+"\") >"+parentArray[k].name+"</span>";

                       }else{
                           navHTML += "<span onclick=clickNav("+parentArray[k].id+",\""+parentArray[k].name+"\") > > "+parentArray[k].name+"</span>";

                       }
                   }
                   attachment_bottom.innerText = res.response.length <= 0?"无更多文件":"点击加载更多";;
                   attachment_list.innerHTML = (HTML_LIST);
                   nav.innerHTML = navHTML;
               }
           },
           onError:function(error){
               console.log(error,'error');
           }
       });
   }


   //点击导航栏事件
   function clickNav(parentId,parentName){
       var indexof = '';
       for(var k in parentArray){
           if(parentArray[k].id == parentId){
               indexof = parseInt(k)+1;
           }
       }
       parentArray = parentArray.slice(0,parseInt(indexof));
       clickFile(1,parentId,parentName);
   }

   //加载更多
   function onEndedPage(e){
       if(e.srcElement.innerText == "无更多文件"){
           return;
       }
       defaultPageNo += 1;
       filterCloudFile();
   }

   //点击遮罩
   function clickMask(){
       AddAttachmentChange('none');
       $('.topic_box').css({display:'none'});
       $('.topic_box').css({transform:'translate(0%,100%)'});
   }

   //点击添加按钮
   function showAddAttachment(){
       AddAttachmentChange('block');
   }

   //改变蚁盘元素显示状态
   function AddAttachmentChange(style){
       var mask = document.getElementById('mask');
       var attachment_box = document.getElementById('attachment_box');
       mask.style.display = style;
       attachment_box.style.display = style;
       window.requestAnimationFrame(function(){
          attachment_box.style.transform = style == 'block'?"translateY(0%)":"translateY(100%)";
       })
   }


   function getWeChatSignature(url) {
       url = window.location.href;
       $.ajax({
           type: "POST",
//            url: "http://192.168.50.34:9006/Excoord_ApiServer/webservice",
            url: "https://www.maaee.com/Excoord_For_Education/webservice",
           data: {
               params: JSON.stringify({
                   "method": 'getWeChatSignature',
                   "url": url,
               })
           },
           success: function (ret) {
               var res = JSON.parse(ret).response;
               wx.config({
                   debug: false,
                    appId: 'wx181574f3ea687daf',  // 线上用的
//                   appId: 'wx9d076742b77044dd',   //测试用的
                   timestamp: res.timestamp,
                   nonceStr: res.noncestr,
                   signature: res.signature,
                   jsApiList: [
                       "checkJsApi",
                       'chooseImage',
                       'uploadImage',
                       'downloadImage',
                       'scanQRCode',
                       'getLocalImgData',
                   ]
               });
               wx.ready(function () {
                   wx.checkJsApi({
                       jsApiList: [
                           "checkJsApi",
                           'chooseImage',
                           'uploadImage',
                           'downloadImage',
                           'scanQRCode',
                           'getLocalImgData',
                       ],
                       success: function (res) { }
                   });
               })
               wx.error(function (res) {
                   console.error(res);
               });
           },
           error: function (responseStr) {
               layer.msg("签名请求出错,选图功能暂不可用");
           }
       });
   }


   //相机点击事件
   $('#album').click(function () {
       wx.chooseImage({
           count: 1, // 默认9
           sizeType: ['original'], // 可以指定是原图还是压缩图，默认二者都有
           sourceType: ['album'], // 可以指定来源是相册还是相机，默认二者都有
           success: (res) => {
               var tempFilePaths = res.localIds[0];
               let load = layer.load(0, { shade: 0.1 });
               wxUploadImage(tempFilePaths,load);

           }
       });
   })

   //相册及相机上传图片事件
   function wxUploadImage(tempFilePaths,load){
       wx.uploadImage({
           localId: tempFilePaths, // 需要上传的图片的本地ID，由chooseImage接口获得
           isShowProgressTips: 0, // 默认为1，显示进度提示
           success: function (res) {
               let serverId = res.serverId; // 返回图片的服务器端ID
               wx.downloadImage({
                   serverId: serverId, // 需要下载的图片的服务器端ID，由uploadImage接口获得
                   isShowProgressTips: 0, // 默认为1，显示进度提示
                   success: function (res) {
                       var localId = res.localId; // 返回图片下载后的本地ID
                       wx.getLocalImgData({
                           localId: localId,
                           success: function (res) {
                               var localData = res.localData;
                               if (localData.indexOf('data:image') != 0) {
                                   //判断是否有这样的头部
                                   localData = 'data:image/jpg;base64,' + localData
                               }
                               localData = localData.replace('jgp', 'jpg');
                               var $Blob = getBlobBydataURI(localData, 'image/jpeg');
                               var formData = new FormData();
                               formData.append("filePath", $Blob, "file_" + Date.parse(new Date()) + ".png");
                               $.ajax({
                                   type: "POST",
                                   url: "https://jiaoxue.maaee.com:8890/Excoord_Upload_Server/file/upload",
                                   enctype: 'multipart/form-data',
                                   data: formData,
                                   // 告诉jQuery不要去处理发送的数据
                                   processData: false,
                                   // 告诉jQuery不要去设置Content-Type请求头
                                   contentType: false,
                                   success: function (res) {
                                       picUrl = res;
                                       $("#image").attr("src",picUrl);
                                       $('.imageBox').show();
                                       layer.close(load);
                                   },
                                   error: function (res) {
                                       layer.msg('上传图片失败,请重试');
                                   }
                               });
                           }
                       });
                   }
               });

           }
       });
   }

   function getBlobBydataURI(dataURI, type) {
       var binary = atob(dataURI.split(',')[1]);
       var array = [];
       for (var i = 0; i < binary.length; i++) {
           array.push(binary.charCodeAt(i));
       }
       return new Blob([new Uint8Array(array)], { type: type });
   }

  //ｓｅｎｄ　推图
   function pushImage(){
       var protocal = eval('(' + "{'command':'pushHandout','data':{'url':'"+picUrl+"',vid:'"+vid+"'}}" + ')');
       clazzConn.send(protocal);


   }

   function closeImage(){
       $('.imageBox').hide();
   }


   $('#shouTu').on('click',function(){
       if($('#shouTu').text() == '收图'){
           //点击收图逻辑
          var protocal = eval('(' + "{'command':'class_shoutu','data':{'type':0,'now':'"+new Date().getTime()+"'}}" + ')');
          clazzConn.send(protocal);
          $('#shouTu').addClass('stop_shou');
          $('#shouTu').text('关闭');
       }else{
           //点击取消逻辑
          var protocal = eval('(' + "{'command':'class_shoutu','data':{'type':1,'now':'"+new Date().getTime()+"'}}" + ')');
          clazzConn.send(protocal);
          $('#shouTu').removeClass('stop_shou');
          $('#shouTu').text('收图');

       }

   })
</script>
</html>