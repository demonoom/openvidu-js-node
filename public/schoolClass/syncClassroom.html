<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>欢迎登录小蚂蚁同步课堂</title>
    <link rel="icon" href="img/logo_title.png" type="image/x-icon">
    <link rel="shortcut icon" href="img/logo_title.png" type="image/x-icon"/>
    <link rel="stylesheet" href="./css/syncClassroom.css">
    <script type="application/javascript" src="js/platform.js"></script>
    <style type="text/css">
        .amplification{
            border: none !important;
            box-shadow: none !important;
        }
        .amplification{
            display: none;
        }
    </style>
</head>
<body>
<div class="mask" style="opacity: 0"></div>
<div class="review_iframe_box">
    <div class="review-modalTitle">
        <span class="review_iframe_title"></span>
        <span class="cancelX layui-layer-setwin">
        <a class="layui-layer-ico layui-layer-close layui-layer-close1" href="javascript:;"></a>
    </span>
    </div>
    <iframe src="" frameborder="0" id="review_iframe"></iframe>
</div>
<div class="wrap">
    <div class="inner">
        <div class="nav">
            <div class="logo"><img src="img/icon_yunClassLogo.png"/></div>

            <div class="userInfo">
                <div class="my_flex">
                    <div class="avatar">
                        <img id="user_avatar" src="" alt="">
                    </div>
                    <div class="username"></div>
                    <div class="exit">退出</div>
                </div>
            </div>
        </div>
        <div class="box_cont">
            <div class="left_box">
                <div class="header">课堂管理</div>
                <div id="classInfo" class="active">正在直播</div>
                <div id="classReview">课程回顾</div>
                <div id="myFile">我的课件</div>
                <div class="header" id="record_tip" style="display: none;">本地录制</div>
                <div id="localRecord" id="record_list" style="display: none;">录制列表</div>
            </div>
            <div class="right_box">
                <!--课程信息 -->
                <div class="classInfo_box">
                    <iframe id="classInfo_iframe" src="" frameborder="0"></iframe>
                </div>
                <!--课程回顾 -->
                <div class="classReview_box">
                    <iframe id="classReview_iframe" src="" frameborder="0"></iframe>
                </div>
                <!--本地录制 -->
                <div class="localRecord_box">
                    <iframe id="localRecord_iframe" src="" frameborder="0"></iframe>
                </div>
                <!--我的课件 -->
                <div class="myFile_box">
                    <iframe id="myFile_iframe" src="" frameborder="0"></iframe>
                </div>
            </div>


        </div>

        <div class="iframeDiv" style="display: none">
            <span id="closeIframe" class="closeIframe">关闭</span>
            <div class="text_hidden">
                <h3 class="iframeTitle"></h3>
            </div>

            <div class="iframeBox calm"></div>
        </div>
    </div>
</div>
</body>
<script src="./js/jquery.min.js"></script>
<script type="application/javascript" src="js/layer/layer.js"></script>
<script type="application/javascript" src="js/service.js"></script>
<script type="application/javascript" src="js/simple_websocket_connection.js"></script>
<script>

var debug = false;
var iframeOrgrin = debug?'http://192.168.50.188:7093':'https://jiaoxue.maaee.com:9093';

    function checkShowRecord(){
        var browser = platform.name;
        if(browser.indexOf("Electron") != -1){
            $("#record_tip").show();
            $("#localRecord").show();
        }else{
            $("#record_tip").hide();
            $("#localRecord").hide();
        }
    }
    checkShowRecord();
    $(function () {
        var simple = new SimpleConnection();
        simple.connect();

        var teacherId = Service.getQueryString("teacherId");
        var teacherName = Service.getQueryString("teacherName");
        getUserById();
        $('#classInfo_iframe').attr('src', 'unionClassList.html?teacherId=' + teacherId + '&teacherName=' + teacherName + '');
        $('#classReview_iframe').attr('src', 'classReviewList.html?teacherId=' + teacherId + '&teacherName=' + teacherName + '');
        $('#myFile_iframe').attr('src', 'https://jiaoxue.maaee.com:8099/#/antPlate?ident=' + teacherId + '&fileId=-1&title=蚁盘题目&phoneType=0')
        $('#localRecord_iframe').attr('src', 'recordList.html?ident=' + teacherId);

        //socket 监听
        simple.clazzWsListener = {
            onError: function (errorMsg) {
            }, onWarn: function (warnMsg) {
            }, onMessage: function (info) {
                var command = info.command;
                var messageData = info.data;
                if (command == "office2PdfSuccess" && messageData.createUid == teacherId) {
                    var cloudFileName = messageData.cloudFileName;
                    var tipMessage = "课件\"" + cloudFileName + "\"已经转码成功!";
                    var tipMessageHTML = "<div class='classText'>" + tipMessage + "</div>";
                    layer.open({
                        type: 1,
                        shade: false,
                        closeBtn: 0,
                        skin: 'yourclass',
                        area: ['100%', '50px'],
                        offset: [0, 0],
                        title: false, //不显示标题
                        time: 3000, //2秒后自动关闭
                        content: tipMessageHTML
                    });
                }
            }
        };

        $('#classInfo').on('click', function () {
            $('#classInfo').addClass('active');
            $('#myFile').removeClass('active');
            $('#classReview').removeClass('active');
            $('.classInfo_box').show();
            $('.myFile_box').hide();
            $('.classReview_box').hide();
            $('#localRecord').removeClass('active');
            $('.localRecord_box').hide();
        })

        $('#myFile').on('click', function () {
            $('#myFile').addClass('active');
            $('#classInfo').removeClass('active');
            $('#classReview').removeClass('active');
            $('.classInfo_box').hide();
            $('.myFile_box').show();
            $('.classReview_box').hide();
            $('#localRecord').removeClass('active');
            $('.localRecord_box').hide();
        });

        $('#localRecord').on('click',function(){
            $('#myFile').removeClass('active');
            $('#classInfo').removeClass('active');
            $('#classReview').removeClass('active');
            $('.classInfo_box').hide();
            $('.myFile_box').hide();
            $('.classReview_box').hide();
            $('#localRecord').addClass('active');
            $('.localRecord_box').show();


        })

        $('#classReview').on('click', function () {
            $('#classReview').addClass('active');
            $('#myFile').removeClass('active');
            $('#classInfo').removeClass('active');
            $('.classInfo_box').hide();
            $('.myFile_box').hide();
            $('.classReview_box').show();
            $('#localRecord').removeClass('active');
            $('.localRecord_box').hide();
        })

        $('#closeIframe').on('click', function () {
            $(".iframeDiv").hide();
            $(".mask").hide()
            document.getElementsByClassName("calm")[0].innerHTML = "";
            document.getElementsByClassName("iframeTitle")[0].innerHTML = "";
        })


        $('.exit').on('click', function () {
            layer.confirm('您确定要退出登录?', {
                btn: ['确定', '取消'], //按钮
            }, function () {
                window.location.href = 'login.html'
            }, function () {
            });
        });


        $('.mask').on('click', function () {
            $('.mask').hide();
            $('.review_iframe_box').hide();
            $('#review_iframe').attr('src', '');


            $(".iframeDiv").hide();
            document.getElementsByClassName("calm")[0].innerHTML = "";
            document.getElementsByClassName("iframeTitle")[0].innerHTML = "";
        });

        $('.cancelX').on('click', function () {
            $('.mask').hide();
            $('.review_iframe_box').hide();
            $('#review_iframe').attr('src', '');
        });

        window.addEventListener('message', function (rs) {
            var res = (rs.data);
            if (res.method == 'showReview') {
                $('.review_iframe_box').show();
                $('.mask').show();
                $('.review_iframe_title').text(res.name);
//                $('#review_iframe').attr('src', 'https://jiaoxue.maaee.com:9093/#/cloundSchoolDetail?vid=' + res.vid + '&userId=' + res.userId + '&type=3&name=' + res.name);
                $('#review_iframe').attr('src', iframeOrgrin+'/#/cloundSchoolDetail?vid=' + res.vid + '&userId=' + res.userId + '&type=3&name=' + res.name);
            } else if (res.method == "watchFiles") {
                var obj = res.data
                var type = obj.suffix

                $(".mask").show();
                $(".iframeDiv").show();
                document.getElementsByClassName("iframeTitle")[0].innerHTML = obj.name;

                if (type == 'mp4') {
                    var url = 'https://www.maaee.com/Excoord_PhoneService/cloudFile/cloudFileShow/' + obj.uuid + '/' + obj.id;
                } else {
                    var url = "https://www.maaee.com/Excoord_PhoneService/cloudFile/cloudFileShow/" + obj.id + "/" + obj.createUid;
                }

                setTimeout(() => {
                    $("<iframe class='iframeBox' src=" + url + "></iframe>").prependTo($(".calm"))
                }, 300)
            }else if(res.method == 'fullScreen'){
                var left = 0;
                var top = document.body.clientHeight - 150 - 42;
                    let index = layer.open({
                      type: 2,
                      title:  $('.review_iframe_title').text(),
                      shadeClose: true,
                      shade: false,
                      skin:'amplification',
                      maxmin: true, //开启最大化最小化按钮
                      area: 'auto',
                      content: iframeOrgrin+"/#/cloundSchoolFullScreen?videoSrc="+encodeURIComponent(res.src) + "&currentTime="+res.currentTime+"&isPlay="+res.isPlay,
                      move:'.layui-layer-title',
                      success: function(layero, index) {
                          $('.layui-layer-content iframe')[0].style = 'height: '+(document.body.clientHeight - 43)+'px';
                      },
                      offset: 'lb',
                      min: function() { //点击最小化后的回调函数
                      },

                      full: function() { //点击最大化后的回调函数
                      //随意设置的最大化 800px 大小
                      $('.layui-layer-content iframe')[0].style = 'height: '+(document.body.clientHeight - 43)+'px';

                      },

                      restore: function() { //点击还原后的回调函数
                      //固定 150 px 的最小化窗口大小
                      $('.layui-layer-content iframe')[0].style = 'height: 150px';
                      // 设置全屏高度后导致拖动窗口高度发生变化,重置窗口高度
                      $('.layui-layer')[0].style.height = '150px';
                      $('.layui-layer').get(0).style.left = left + 'px';
                      $('.layui-layer').get(0).style.top = top +'px';
                      },
                      cancel: function(){
                      let data = {
                          method: 'willCancel',
                      }
                      $('.layui-layer-content iframe').get(0).contentWindow.postMessage(data,'*');
                      },
                      moveEnd: function(layero){
                                              left = $('.layui-layer').get(0).style.left.toString().substring($('.layui-layer').get(0).style.left.toString().length - 2,$('.layui-layer').get(0).style.left.toString().length);
                                              top = $('.layui-layer').get(0).style.top.toString().substring($('.layui-layer').get(0).style.top.toString().length - 2,$('.layui-layer').get(0).style.top.toString().length);
                       }
                    });
                    $('.layui-layer-content iframe')[0].style = 'height: '+(document.body.clientHeight - 43)+'px';
                    $('.layui-layer').get(0).style.left = left;
                    layer.full(index,function(){
                        $('.layui-layer').show();
                    });
                    $('.layui-layer').get(0).style.left = left;

            }else if(res.method == 'didCancel'){
                $('#review_iframe').get(0).contentWindow.postMessage(res,'*');
            }
        });


        function getUserById() {
            $.ajax({
                type: "POST",
                url: "https://www.maaee.com/Excoord_For_Education/webservice",
                data: {
                    params: JSON.stringify({
                        "method": "getUserById",
                        "ident": teacherId,
                    })
                },
                header: {
                    "content-type": "application/x-www-form-urlencoded;charset=UTF-8"
                },
                success: function (data) {
                    var res = JSON.parse(data);
                    if (res.success) {
                        $('#user_avatar').attr('src', res.response.avatar);
                        $('.username').text(res.response.userName);
                    } else {
                        alert('用户不存在');
                    }
                },
                error: function (e) {
                }
            });
        }
    })
</script>
</html>