<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Document</title>
<link rel="stylesheet" href="./css/recordList_local.css">
</head>
<body>
<div class="nav">
    <span class="record_title">录制列表</span>
  <div class="nav_right">
    <span>默认输出路径</span>
      <span id="dir_input" class="text_hidden"></span>
    <span id="updateDir"></span>
  </div>
</div>

<div class="list_view">
    <div class="list_title my_flex">
        <div class="noomWidth my_flex">
            <div class="list_titleItem courseName">课程名</div>
            <div class="list_titleItem fileName">文件名</div>
        </div>
        <div class="list_titleItem time">创建时间</div>
        <div class="list_titleItem size">大小</div>
        <div class="list_titleItem option">操作</div>
    </div>
    <div class="list_body">
        <!--
        <div class="list_item">传统民居</div>
        <div class="list_item">微课</div>
        <div class="list_item">05:00:22</div>
        <div class="list_item">4.5MB</div>
        <div class="list_item">
             <button onclick="openFile()">播放</button>
             <button onclick="openFolder()">打开文件夹</button>
        </div>
        -->
    </div>
</div>

</body>
<script type="application/javascript" src="js/service.js"></script>
<script src="./js/jquery-3.2.1.min.js"></script>
<!--<script src="./js/require.js"></script>-->
<script>
const electron = window.parent.require('electron');
const {shell} = electron;
const {dialog} = window.parent.require('electron').remote;
const fs = window.parent.require('fs');
var teacherId = Service.getQueryString('ident');
console.log(teacherId);

var infos = JSON.parse(localStorage.getItem(teacherId+"_savedVideoInfos")) || [];
// var infos = [{
//     id:1,
//     clazzName:'常规课',
//     fileName:'文件名',
//     createTime:1543827957472,
//     filePath:'/home/fanbo/视频/26897f6d-7043-4972-8631-ea63420111ca.mp4',
//     size:8
// },{
//       id:1,
//       clazzName:'实景课',
//       fileName:'文件名',
//       createTime:1543827957472,
//       filePath:'/home/fanbo/视频/26897f6d-7043-4972-8631-ea63420111ca.mp4',
//       size:8
// },{
//         id:1,
//         clazzName:'常规课',
//         fileName:'文件名',
//         createTime:1543827957472,
//         filePath:'/home/fanbo/视频/26897f6d-7043-4972-8631-ea63420111ca.mp4',
//         size:8
// }]
var rootDir = localStorage.getItem('video_save_folder');
console.log(rootDir);
var fileNames = [];
var listArray = [];
$(function () {
    $('.list_body').empty();
    loadFiles();

});

//根据根目录遍历渲染文件
function loadFiles(){


    infos.map((value,index)=>{
        var obj = {
            className:value.clazzName?value.clazzName:'',
            fileName: value.fileName?value.fileName:'',
            filePath: value.filePath?value.filePath:'',
            fileDirPath: rootDir?rootDir:'',
            fileTime: datetimeFormat(value.createTime),
            fileSize: (value.size?(value.size / 1024 / 1024).toFixed(2):0) + 'MB',
        };
        listArray.push(obj);
    });
    $('#dir_input').text(rootDir);


//    //置空
//    console.log($('.list_body'),'已清空的');
//    // console.log($('.list_body').html(),'')
//    $('#dir_input').val(rootDir);
//    fs.readdirSync(rootDir).map((value, index) => {
//        fileNames.push(value);
//    })
//    fileNames.map((value, index) => {
//        // console.log(rootDir+'/'+value,'文件路径')
//        var stats = fs.statSync(rootDir + '/' + value);
//        // console.log(stats,'stats');
//        console.log(value, '文件名称');
//        console.log((stats.size / 1024 / 1024).toFixed(2), '文件大小');
//        console.log(stats,'stats');
//        var obj = {
//            className:'常规课',
//            fileName: value,
//            filePath: rootDir + '/' + value,
//            fileDirPath: rootDir,
//            fileTime: '03:22:17',
//            fileSize: (stats.size / 1024 / 1024).toFixed(2) + 'MB',
//        };
//        listArray.push(obj);
//    });
    //将file对象渲染至页面
    if (listArray.length == 0) {
        $('.list_body').append("<div class='empty' style='text-align: center;'>本地暂无文件</div>")
    } else {
        //遍历当前目录下的文件
        listArray.map((value, index) => {
            appendToList(value);
        })
    }
}


function openFile(path) {
    var url = "recordVideoPreview.html?filePath="+decodeURIComponent(path.replace(/\\/g,"\\\\"));
    window.open(url);
}

function openFolder(path) {
    console.log('打开文件夹');
    shell.openItem(rootDir,function(err){
        console.log(err);
    });
}

/*
 ** 添加对象至list_body元素中
 */
function appendToList(obj) {
    if(obj.filePath){
        obj.filePath = obj.filePath.replace(/\\/g,"\\\\");
    }
    var html = "<div class='list_item my_flex'>" +
        "<div class='noomWidth my_flex'><div class='list_bodyItem courseName text_hidden'><img class='filePic' src='img/icon_recordFile.png'/>" + obj.className + "</div><div class='list_bodyItem fileName text_hidden'>" + obj.fileName + "</div></div>"+
        "<div class='list_bodyItem time'>" + obj.fileTime + "</div>"+
        "<div class='list_bodyItem size'>" + obj.fileSize + "</div>"+
        "<div class='list_bodyItem option'>" +
        "    <button onclick='openFile(\""+obj.filePath+"\")'>播放</button>" +
//        '     <button onclick="openFolder()">打开文件夹</button>' +
        "</div></div>";
    $('.list_body').append(html);
}

$('#updateDir').on('click',function(){
    console.log('更改文件夹路径');
    dialog.showOpenDialog({ properties: ['openDirectory']},function(res){
        console.log(res[0]);
        rootDir = res[0];
        //重新渲染
        fileNames.splice(0);
        listArray.splice(0);
        localStorage.setItem('video_save_folder',rootDir);
        $('#dir_input').text(rootDir);
//        $('.list_body').empty();
//        loadFiles();
    })

})


function datetimeFormat(longTypeDate){
        var dateTypeDate = "";
        var date = new Date();
        date.setTime(longTypeDate);
        dateTypeDate += date.getFullYear(); //年
        dateTypeDate += "-" + getMonth(date); //月
        dateTypeDate += "-" + getDay(date); //日
        dateTypeDate += " " + getHours(date); //时
        dateTypeDate += ":" + getMinutes(date);  //分
        return dateTypeDate;
    }

    function getMonth(date){
        var month = "";
        month = date.getMonth() + 1; //getMonth()得到的月份是0-11
        if(month<10){
            month = "0" + month;
        }
        return month;
    }

    function getDay(date){
        var day = "";
        day = date.getDate();
        if(day<10){
            day = "0" + day;
        }
        return day;
    }

    function getHours(date){
        var hours = "";
        hours = date.getHours();
        if(hours<10){
            hours = "0" + hours;
        }
        return hours;
    }

    function getMinutes(date){
        var minute = "";
        minute = date.getMinutes();
        if(minute<10){
            minute = "0" + minute;
        }
        return minute;
    }
</script>
</html>