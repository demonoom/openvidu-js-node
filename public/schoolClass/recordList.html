<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Document</title>
<link rel="stylesheet" href="./css/recordList_local.css">
</head>
<body>
<div class="nav">
    <span class="record_title">录制列表</span>
  <div class="nav_right">
    <span>默认输出路径</span>
      <span id="dir_input"></span>
    <span id="updateDir"></span>
  </div>
</div>

<div class="list_view">
    <div class="list_title my_flex">
        <div class="noomWidth my_flex">
            <div class="list_titleItem courseName">课程名</div>
            <div class="list_titleItem fileName">文件名</div>
        </div>
        <div class="list_titleItem time">创建时间</div>
        <div class="list_titleItem option">操作</div>
    </div>
    <div class="list_body">
        <!--
        <div class="list_item">传统民居</div>
        <div class="list_item">微课</div>
        <div class="list_item">05:00:22</div>
        <div class="list_item">4.5MB</div>
        <div class="list_item">
             <button onclick="openFile()">播放</button>
             <button onclick="openFolder()">打开文件夹</button>
        </div>
        -->
    </div>
</div>

</body>
<script type="application/javascript" src="js/service.js"></script>
<script src="./js/jquery-3.2.1.min.js"></script>
<script src="./js/layer/layer.js"></script>
<!--<script src="./js/require.js"></script>-->
<script>
const electron = window.parent.require('electron');
const {dialog} = window.parent.require('electron').remote;
var appRootPath = getDefaultVideoSavePath();
const {shell} = electron;
const fs = window.parent.require('fs');
var teacherId,infos,rootDir;
$(function () {
    teacherId = Service.getQueryString('ident');
    infos = JSON.parse(localStorage.getItem(teacherId+"_savedVideoInfos")) || [];
    rootDir = localStorage.getItem('video_save_folder') || appRootPath;
    loadFiles();
});

//根据根目录遍历渲染文件
function loadFiles(){
    //清空list元素
    $('.list_body').empty();
    //动态获取根目录路径
    $('#dir_input').text(rootDir);

    if (infos.length == 0) {
        $('.list_body').append("<div class='empty' style='text-align: center;'>本地暂无文件</div>");
    }else{
        //遍历创建对象
        infos.map((value,index)=>{
            appendToList({
                className:value.clazzName?value.clazzName:'',
                fileName: value.fileName?value.fileName:'',
                filePath: value.filePath?value.filePath:'',
                fileDirPath: rootDir?rootDir:'',
                fileTime: datetimeFormat(value.createTime),
                fileSize: (value.size?(value.size / 1024 / 1024).toFixed(2):0) + 'MB',
                id: value.id
            });
        });
    }
}

function getDefaultVideoSavePath(){
    return "C:\\LittleAntTeachingRecord\\";
}

/*
 ** 添加对象至list_body元素中
 */
function appendToList(obj) {
    if(obj.filePath){
        obj.filePath = obj.filePath.replace(/\\/g,"\\\\");
    }
    var html = "<div class='list_item my_flex'>" +
        "<div class='noomWidth my_flex'><div class='list_bodyItem courseName text_hidden'><img class='filePic' src='img/icon_recordFile.png'/>" + obj.className + "</div><div class='list_bodyItem fileName text_hidden'>" + obj.fileName + "</div></div>"+
        "<div class='list_bodyItem time'>" + obj.fileTime + "</div>"+
        /*"<div class='list_bodyItem size'>" + obj.fileSize + "</div>"+*/
        "<div class='list_bodyItem option'>" +
        "    <button class='playBtn' onclick='openFile(\""+obj.filePath+"\")'>播放</button>" +
        "    <button class='deleteBtn' onclick='deleteFile(\""+obj.id+"\",\""+obj.filePath+"\")'>删除</button>" +
//        '     <button onclick="openFolder()">打开文件夹</button>' +
        "</div></div>";
    $('.list_body').append(html);
}

//打开文件
function openFile(path) {
    var url = "recordVideoPreview.html?filePath="+decodeURIComponent(path.replace(/\\/g,"\\\\"));
    window.open(url);
}

//打开文件夹
function openFolder(path) {
    shell.openItem(rootDir,function(err){
        console.log(err);
    });
}

//删除文件
function deleteFile(id,filePath){
    if(!id){
        console.log('此id为空');
        return;
    }
    layer.confirm('确认删除文件？', {
        btn: ['确认','取消'] //按钮
    }, function(){ //确认回调
        //要删除的数组下标以及文件路径
        var deleteIndex = null,deletePath = null;
        for(var k in infos){
            if(infos[k].id === id){
                deleteIndex = k;
                deletePath = infos[k].filePath;
            }
        }
        if(deleteIndex && deletePath){
            fs.unlink(deletePath,function(err){
                // if(err){
                //     layer.msg('删除出错', {icon: 1});
                // }else{
                    infos.splice(deleteIndex,1);
                    localStorage.setItem(teacherId+"_savedVideoInfos",JSON.stringify(infos));
                    loadFiles();
                    layer.msg('文件已删除', {icon: 1});
                // }
            });
        }else{
            layer.msg('删除出错', {icon: 2});
        }
    }, function(){});
}

//更改输出路径
$('#updateDir').on('click',function(){
    dialog.showOpenDialog({ properties: ['openDirectory']},function(res){
        rootDir = res[0];
        localStorage.setItem('video_save_folder',rootDir);
        $('#dir_input').text(rootDir);
    })

})

//格式化日期
function datetimeFormat(longTypeDate){
        var dateTypeDate = "";
        var date = new Date();
        date.setTime(longTypeDate);
        dateTypeDate += date.getFullYear(); //年
        dateTypeDate += "-" + getMonth(date); //月
        dateTypeDate += "-" + getDay(date); //日
        dateTypeDate += " " + getHours(date); //时
        dateTypeDate += ":" + getMinutes(date);  //分
        return dateTypeDate;
    }

    function getMonth(date){
        var month = "";
        month = date.getMonth() + 1; //getMonth()得到的月份是0-11
        if(month<10){
            month = "0" + month;
        }
        return month;
    }

    function getDay(date){
        var day = "";
        day = date.getDate();
        if(day<10){
            day = "0" + day;
        }
        return day;
    }

    function getHours(date){
        var hours = "";
        hours = date.getHours();
        if(hours<10){
            hours = "0" + hours;
        }
        return hours;
    }

    function getMinutes(date){
        var minute = "";
        minute = date.getMinutes();
        if(minute<10){
            minute = "0" + minute;
        }
        return minute;
    }
</script>
</html>